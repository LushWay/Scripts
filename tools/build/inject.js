import { writeFile } from 'fs/promises'
import path from 'path'

/**
 * @param {string} modifier
 * @param {string} code
 */
function injectCode(modifier, code) {
  return `// prettier-ignore
/* eslint-disable */
// This file is autogenerated by ${modifier}.
// Do not modify manually.
    
${code}
`.replace(/(?:\r)?\n/g, '\r\n')
}

/**
 * @param {string} asset
 * @param {string} caller
 * @param {string | (() => Promise<string> | string)} code
 */
export async function injectAsset(asset, caller, code, base = '.') {
  try {
    if (typeof code === 'function') code = await code()

    await writeFile(path.join(base, 'src', 'lib', 'assets', asset), injectCode(caller, code))
  } catch (e) {
    console.error(`Unable to write asset ${asset}:`, e)
  }
}

/** @param {string} k */
export function toUpper(k) {
  const id = k.replace(/(?:\/|_)(.)?/g, (_, e) => e?.toUpperCase() ?? '')
  return id[0].toUpperCase() + id.slice(1)
}

/**
 * @param {string} name
 * @param {[string, string][]} entries
 */
export function injectEnum(name, entries) {
  return `export enum ${name} {
${entries.map(([k, e]) => `  ${toUpper(k)} = '${e}',`).join('\n')}
}`
}
